<!doctype html>
<html>
   <head>
      <link href='http://fonts.googleapis.com/css?family=Inconsolata:700' rel='stylesheet' type='text/css'>
      <style>
         body{
             background-color:lightGrey;
         }

         #element24{
             font-size:80px;
             padding:0px;
             margin:0px;
             position:relative;
             bottom:90px;
             right:21px;
         }

         h1{
             font-family: 'Inconsolata',sans-serif;
             color:white;
             text-shadow:0 0 10px #00CC99;
         }

        #title{
            position:relative;
            left:760px;
            width:500px;
            bottom:195px;
        }

         #container{
            border:thin solid white;
            height:500px;
            width:1000px;
            position:relative;
            top:30px;
            background-color:gray;
            margin:0px 0px 100px 0px;
         }

         #header{
             width:auto;
             height:50px;
             background-color:gray;
             margin:0px;
             padding:0px;
         }
         
         #trapezoid{
             border-top:50px solid gray;
             border-left:50px solid transparent;
             border-right:50px solid transparent;
             height:0;
             width:150px;
             position:relative;
             left:100px;
         }

         .healthBar{
            height:30px;
            width:350px;
            background-color:white;
            margin:50px 50px 0px 50px;
            border-radius:10px;
         }

         .textbox{
            height:300px;
            width:350px;
            background-color:white;
            margin:20px 50px 0px 50px;
            border-radius:5px;
         }

         .first{
            display:inline-block;
         }

         .second{
            display:inline-block;
         }

      </style>

      <script src='/_ah/channel/jsapi'></script>
   </head>
   <body>
      <div id="header"></div>
      <div id="trapezoid">
          <h1 id="element24">&lt;24/&gt;</h1>
          <h1 id="title">XTreme Typing</h1>
      </div>
      <center>

      <div id='other-player' style='display:none'>
        Waiting for another player to join.<br>
        Send them this link to play:<br>
        <div id='game-link'><a href='{{ game_link }}'>{{ game_link }}</a></div>
      </div>

      <div id="container" style='display:none'>
         <div class="healthBar first" id="firstBar"></div>
         <div class="healthBar second" id="secondBar"></div>
         <div class="textbox first" id="firstBox"></div>
         <div class="textbox second" id="secondBox"></div>
         </div>
      </center>


      <script type='text/javascript'>
var state = {
   game_key: '{{ game_key }}',
   me: '{{ me }}',
};

updateGame = function() {
   
   var display = {
      'other-player': 'none',
      'container': 'none'
   }; 

   if (!state.userB || state.userB == '') {
      display['other-player'] = 'block';
   }
   else {
      display['container'] = 'block';
   }

   for (var label in display) {
      document.getElementById(label).style.display = display[label];
   }
};

sendMessage = function(path, opt_param) {
   path += '?g=' + state.game_key;
   if (opt_param) {
      path += '&' + opt_param;
   }
   var xhr = new XMLHttpRequest();
   xhr.open('POST', path, true);
   xhr.send();
};

// data should include:
// block
// index
// health
sendGameStatusMessage = function(data) {
   var xhr = new XMLHttpRequest();
   xhr.open('POST', '/sync?g=' + state.game_key, true);
   xhr.setRequestHeader('Content-Type', 'application/json');
   xhr.send(JSON.stringify(data));
};

// data should include:
// type 
// user
// (data = {type: "reverse", user: 2343})
sendPowerUpMessage = function(data) {
   var xhr = new XMLHttpRequest();
   xhr.open('POST', '/powerup?g=' + state.game_key, true);
   xhr.setRequestHeader('Content-Type', 'application/json');
   xhr.send(JSON.stringify(data));
}

onOpened = function() {
   sendMessage('/opened');
};
   
onMessage = function(m) {
   newState = JSON.parse(m.data.replace(/&quot;/g,'"'));
   state.userA = newState.userA || state.userA;
   state.userB = newState.userB || state.userB;

   if (state.userB == state.me) {
      if (newState.userABlock != "")
         state.opponentBlock = newState.userABlock;
      state.opponentPointerIndex = newState.userAPointerIndex || state.opponentPointerIndex;
   }

   else if (state.userA == state.me) {
      if (newState.userBBlock != "")
         state.opponentBlock = newState.userBBlock;
         state.opponentPointerIndex = newState.userBPointerIndex || state.opponentPointerIndex;
   }

   updateGame();

   //powerup
}

openChannel = function() {
 var token = '{{ token }}';
 var channel = new goog.appengine.Channel(token);
 var handler = {
   'onopen': onOpened,
   'onmessage': onMessage,
   'onerror': function() {},
   'onclose': function() {}
 };
 var socket = channel.open(handler);
 socket.onopen = onOpened;
}

initialize = function() {
 openChannel();
 // initialize game information
 onMessage({data: '{{ initial_message }}'});
}      

setTimeout(initialize, 100);

      </script>
   </body>
</html>
