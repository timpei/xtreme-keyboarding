<!doctype html>
<html>
   <head>
      <link href='http://fonts.googleapis.com/css?family=Inconsolata:700' rel='stylesheet' type='text/css'>
      <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
      

      <style>
         body{
             background-color:lightGrey;
             min-width:1000px;
             text-align: center;
         }

         #element24{
             position:relative;
             left:650px;
             bottom:235px;
         }

         h1{
             font-family: 'Inconsolata',sans-serif;
             color:white;
             text-shadow:0 0 10px #00CC99;
         }

        #title{
            position:relative;
            font-size:60px;
            width:500px;
            right:30px;
            bottom:120px;
        }

         #container{
            height:550px;
            width:1050px;
            position:relative;
            top:30px;
            background-color:gray;
            padding:10px 0px 0px 0px;
            margin:0px 0px 100px 0px;
            border-radius:5px;
         }
  
         #header{
             width:auto;
             height:50px;
             background-color:gray;
             margin:0px;
             padding:0px;
             border-radius:5px;
         }
         
         #trapezoid{
             border-top:50px solid gray;
             border-left:50px solid transparent;
             border-right:50px solid transparent;
             height:0;
             width:450px;
             position:relative;
             right:300px;
         }

         .healthBar{
            height:15px;
            width:350px;
            background-color:white;
            margin:50px 50px 0px 50px;
            border-radius:10px;
         }

         .textbox{
            height:300px;
            width:350px;
            background-color:white;
            margin:20px 50px 0px 50px;
            border:3px solid black;
            border-radius:5px;
         }

         .first{
           display:inline-block;
           position:relative;
         }

         .second{
            display:inline-block;
         }
         
         .healthInner{
            height:15px;
            border-radius:10px;
            background-color:#00CC99;
            float:left;
            position:relative;
         }

         #other-player{
            font-family: 'Inconsolata',sans-serif;
            position:relative;
            top:50px;
         }

         #sentence1{
            color:white;
            font-size:100px;
            position:relative;
            text-shadow:0 0 10px #00CC99;
            right:300px;
         }

         #anxious{
            text-shadow:0 0 60px red;
            font-size:130px;
         }

         #dw{
            font-size:60px;
         }
            

         #sentence2{
            font-size:25px;
            position:relative;
            top:20px;
         }

         #sentence3{
            font-size:25px;
            color:white;
            position:relative;
            top:20px;
         }

         #sentence4{
            position:relative;
            font-size:25px;
            top:20px;
         }

         img{
            position:relative;
            bottom:350px;
            left:200px;
            height:400px;
            width:auto;
         }

         .progressBox{
            background-color:black;
            height:80px;
            width:70px;
            border-radius:5px;
            position:relative;
            bottom:300px;
            right:440px;
            font-family: 'Inconsolata',sans-serif;
         }

         .progress{
            position:relative;
            top:15px;
         }

         #progressBox2{
            position:relative;
            left:440px;
            bottom:402px;
         }

         .complete{
            position:relative;
            color:white;
         }

         #playerOneText{
            font-family: 'Inconsolata',sans-serif;
            text-shadow:0 0 10px #00CC99;
            color:white;
            -webkit-transform:rotate(-90deg);
            font-size:80px;
            position:absolute;
            right:855px;
         }

         #playerTwoText{
            font-family: 'Inconsolata',sans-serif;
            text-shadow:0 0 10px #00CC99;
            color:white;
            -webkit-transform:rotate(90deg);
            font-size:80px;
            position:absolute;
            width:300px;
            left:-118px;
            top:140px;
         }

         .countdownText{
            font-family: 'Inconsolata',sans-serif;
            font-size: 5em;
            color: white;
            text-shadow:0 0 10px #00CC99;
            position:absolute;
            left:500px; 
            bottom:450px;
         }

         canvas{
            position:relative;
            right: 0px;
         }

         #bottomBar{
            background-color:gray;
            height:130px;
            width:1000px;
            border-radius:5px;
            position:relative;
            bottom:350px;
         }

         #box1{
            height:100px;
            width:355px;
            background-color:black;
            border-radius:5px;
            position:absolute;
            right:527px;
            top:280px;
         }
         
         #box2{
            height:100px;
            width:355px;
            background-color:black;
            border-radius:5px;
            position:absolute;
            right:67px;
            top:280px;
         }

         .comboBox{
            font-family: 'Inconsolata',sans-serif;
            position:relative;
            right:130px;
         }

         .comboText{
            color:white;
            position:relative;
            right:130px;
            bottom:15px;
         }
      </style>

      <script src='/_ah/channel/jsapi'></script>
   </head>
   <body> 
      <center>
      <div id="outerwrapper">
      <div id="header"></div>
      <div id="trapezoid">
          <h1 id="title">XTreme Typing</h1>
          <h1 id="element24">&lt;24/&gt;</h1>
      </div>
      </div>

      <div id='other-player' style='display:none'>
        <div id="sentence1"><div id="anxious">ANXIOUS</div> FINGERS?</div><br>
        <img src="assets/blueTyper.png"/>
        <div id="bottomBar">
        <div id="sentence2">Copy and paste this link to a friend:</div>
        <div id='sentence3'>{{ game_link }}</div><br>
        <div id="sentence4">We'll load the game automatically once your opponent joins.</div>
        </div>
      </div>

      <div id="container" style="display:none">
         <div class="healthBar first" id="firstBar">
            <div class="healthInner first" id="firstInnerBar" style="width:100%"></div>
         </div>
         <div class="healthBar second" id="secondBar">
            <div class="healthInner second" id="secondInnerBar" style="width:100%"></div>
         </div>
         <div class="countdownText">5</div>

          <div class="textbox first" id="firstBox"> </div>
         <div class="textbox second" id="secondBox"></div>
         <div class="progressBox" id="progressBox1">
            <h1 class="progress" id="progress1">0%</h1> 
            <h5 class="complete">complete</h5>
         </div>
         <div class="progressBox" id="progressBox2">
            <h1 class="progress" id="progress2">0%</h1> 
            <h5 class="complete">complete</h5>
         <div id="box1">
            <h1 class="comboBox" id="comboxBox1">0</h1>
            <div class="comboText" id="comboText1">combo</div>
            <div class="messageBox" id="messageBox1"></div>
         </div>

         <div id="box2">
            <h1 class="comboBox" id="comboxBox2">0</h1>
            <div class="comboText" id="comboText2">combo</div>
            <div class="messageBox" id="messageBox2"></div>
         </div>

         <h1 id="playerOneText">YOU</h1>
         <h1 id="playerTwoText">NOT YOU</h1>
             
             
         </div>
      </center>

  <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.5.4.min.js"></script>
      <script>  // <script defer="defer"> wait for the entire page to load before displaying
var startgame = false;

countDown = function() {


          function printBoard(str){
             $(".countdownText").text(str);
          }
          
          var i = 5;

          setInterval(function(){
            if (i == 0) {
              printBoard('0');
            }
            else if (i == -1) {
              printBoard('');
              startgame = true;
              return;
            }
            else {
              printBoard(i);
            }
            i--;
          }, 1000);
          console.log(startgame);
        }

 countDown();

var stage = new Kinetic.Stage({
        container: 'firstBox',
        width: 900,
        height: 300,
      });

var circleLayer = new Kinetic.Layer();
var circle = new Kinetic.Circle({
        x: 1,
        y: 1,
        radius: 100,
        stroke: 'red'
      });

stage.add(circleLayer);

var waiting = new Kinetic.Animation(function(frame) {
       if(startgame)
          circle.fire('mousedown');
      }, circleLayer);

waiting.start();

circle.on('mousedown touchstart', function() {
waiting.stop();
 console.log('pressdown');

     
  var generatedString = "Ever since the Griffin, a foot-long ship built by the French explorer Rene-Robert Cavelier, Sieur de La Salle, in his quest to find the mouth of the Mississippi River, disappeared somewhere on the Great Lakes three years ago, people have been searching for its resting place.Ever since the Griffin, a foot-long ship built by the French explorer Rene-Robert Cavelier, Sieur de La Salle, in his quest to find the mouth of the Mississippi River, disappeared somewhere on the Great Lakes three hundred years ago, people have been searching for its resting place.";
    
      var layer = new Kinetic.Layer();
      var canvases = document.getElementsByTagName("canvas");

          var xmult = 0;
          var ymult = 0;

//your text
//for each character in the string/block of test, create a canvas element thing
      for(var n = 0; n < generatedString.length; n++) {        
  
          //every time maxchar is reached, make a new line
          if( (n+1)%25 == 0 ) {
              xmult = 1;
              ymult++;
          }
          else {
              xmult++;
          }
          var i = n;
          var color;
          var style;
          if(n == 0) {
            color = 'red';
            style = 'bold italic';
          }
          else {
            color = 'black';
            style = 'normal';
          }
            
          var text = new Kinetic.Text({
             x: xmult * 13,
             y: ymult * 20,
            fill: color,
            text: generatedString[i],
            name: 'text',
            fontSize: 20,
            fontFamily: 'Courier',  //maybe Inconsolata
            fontStyle: style
          });
        layer.add(text);
        console.log('text added');
      }

      stage.add(layer);

 var xmult2 = 0;
var ymult2 = 0;

//opponent's text
var layer2 = new Kinetic.Layer();

for(var n = 0; n < generatedString.length; n++) {        
  
          //every time maxchar is reached, make a new line
          if( (n+1)%25 == 0 ) {
              xmult2 = 1;
              ymult2++;
          }
          else {
              xmult2++;
          }
          var i = n;
          var text = new Kinetic.Text({
             x: xmult2 * 13 + 460,
             y: ymult2 * 20,
            fill: 'black',
            text: generatedString[i],
            name: 'text',
            fontSize: 20,
            fontFamily: 'Courier',  //maybe Inconsolata
          });
        layer2.add(text);
      }

      stage.add(layer2);

var cur = 0;
      var clear = false;

      var correct = new Kinetic.Animation(function(frame) {
        var word = alltext[cur];  
        word.setFill('green');
        if(cur == 0)
          word.setFontStyle('bold italic');

        if(cur<alltext.length) {
          var word2 = alltext[cur+1];
          word2.setFill('red');
          word2.setFontStyle('bold italic');
        }
        cur++;
      }, layer );

     // function wave(n) {
          var wave = new Kinetic.Animation(function(frame) {
          var time = frame.time;
          var n = cur;
          var word = alltext[0];
          word.setX(amplitude * Math.sin(frame.time * 2 * Math.PI / period) + centerX);
        }, layer);
      //}  //end of wave function
      


      var alltext = stage.get('.text');
      var numincorrect = 0;
//look for keypress and check if key press is equal to current character
             $(document).keypress(function(evt){
              evt.preventDefault()
               var keynum = evt.keyCode;
               var typed = String.fromCharCode(keynum);
               
               if(typed == generatedString.charAt(0)) {
                //change the color of the current character to green if correct 
                   correct.start();
                   correct.stop();
                  generatedString = generatedString.substring(1);
                  //console.log(generatedString); 
               }
               else {
                //wave.start();
                  numincorrect++;
                console.log('Incorrect: ' + numincorrect);
              }

            }); 
 });  //end of event listener





         function decreaseHealth(player){ //player is an integer; either 1 or 2
            if(player == 1){
               $("#firstInnerBar")[0].style.width = parseFloat($("#firstInnerBar")[0].style.width) - 5 + "%";
               if(parseFloat($("#firstInnerBar")[0].style.width) > 75){
                  $("#firstInnerBar")[0].style.backgroundColor = "#00CC99";
               } else if(parseFloat($("#firstInnerBar")[0].style.width) > 30){
                  $("#firstInnerBar")[0].style.backgroundColor = "orange";
               } else {
                  $("#firstInnerBar")[0].style.backgroundColor = "red";
               }

                   
            } else {
               $("#secondInnerBar")[0].style.width = parseFloat($("#secondInnerBar")[0].style.width) - 5 + "%";
               if(parseFloat($("#secondInnerBar")[0].style.width) > 75){
                  $("#secondInnerBar")[0].style.backgroundColor = "#00CC99";
               } else if(parseFloat($("#secondInnerBar")[0].style.width) > 30){
                  $("#secondInnerBar")[0].style.backgroundColor = "orange";
               } else {
                  $("#secondInnerBar")[0].style.backgroundColor = "red";
               }
            }
         }

         function updateProgress(player){
            if(player == 1){
               if(parseFloat($("#progress1")[0].innerText) < 100)
                  $("#progress1")[0].innerText = parseFloat($("#progress1")[0].innerText) + 10 + "%";
            } else {
               if(parseFloat($("#progress2")[0].innerText) < 100)
                  $("#progress2")[0].innerText = parseFloat($("#progress2")[0].innerText) + 10 + "%";
            }
         }
        


     
        var state = {
          game_key: '{{ game_key }}',
          me: '{{ me }}'
        };

        


        updateGame = function() {
          
          var display = {
            'other-player': 'none',
            'container': 'none'
          }; 

          if (!state.userB || state.userB == '') {
           display['other-player'] = 'block';
          }
          else {
              display['container'] = 'block';
          }
          
          for (var label in display) {
            document.getElementById(label).style.display = display[label];
          }
        };
        
        sendMessage = function(path, opt_param) {
          path += '?g=' + state.game_key;
          if (opt_param) {
            path += '&' + opt_param;
          }
          var xhr = new XMLHttpRequest();
          xhr.open('POST', path, true);
          xhr.send();
        };
        
        onOpened = function() {
          sendMessage('/opened');
        };
        
        onMessage = function(m) {
          newState = JSON.parse(m.data.replace(/&quot;/g,'"'));
          state.userA = newState.userA || state.userA;
          state.userB = newState.userB || state.userB;
          state.winner = newState.winner || "";
          updateGame();
        }
        
        openChannel = function() {
          var token = '{{ token }}';
          var channel = new goog.appengine.Channel(token);
          var handler = {
            'onopen': onOpened,
            'onmessage': onMessage,
            'onerror': function() {},
            'onclose': function() {}
          };
          var socket = channel.open(handler);
          socket.onopen = onOpened;
        }
        
        initialize = function() {
          openChannel();
          // initialize game information
          onMessage({data: '{{ initial_message }}'});
        }      

        setTimeout(initialize, 100);

      </script>
   </body>
</html>
